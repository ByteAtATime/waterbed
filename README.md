# Waterbed

A type-safe query builder for Airtable.

Waterbed brings a modern, Drizzle-like developer experience to your Airtable bases. It allows you to interact with your data using a fluent, type-safe API. With automatic schema generation, you get auto-completion for your table and field names right in your editor.

## Installation

```bash
bun add waterbed

pnpm add waterbed
```

## Getting Started

### 1. Generate Your Schema

The first step is to generate a typed schema from your Airtable base. Waterbed provides a CLI tool for this purpose.

First, create a `.env` file in your project root with your Airtable credentials. You will need a [Personal Access Token](https://airtable.com/create/tokens) with the `schema.bases:read` scope.

```env
# .env
AIRTABLE_API_KEY="pats..."
AIRTABLE_BASE_ID="app..."
```

Now, run the introspection command from your project's root directory:

```bash
npx waterbed
```

Alternatively, you may specify the schema path as an argument:

```bash
npx waterbed src/custom/schema.ts
```

This will connect to the Airtable Metadata API and create a `src/generated-schema.ts` file in your project. This file contains typed definitions for all your tables, fields, and views.

**Example `src/generated-schema.ts`:**

```typescript
// This file is auto-generated. Do not edit this file directly.
import { table, text, number, boolean } from 'waterbed';

// Table: Projects
export const projects = table('Projects', {
    projectName: text('Project Name'),
    budget: number('Budget'),
    isComplete: boolean('Is Complete'),
    views: {
        'activeProjects': 'Active Projects',
        'completed': 'Completed',
    },
});

// ... other tables are also generated
```

### 2. Initialize the Client

Import `base` from Waterbed and your newly generated schema to create a database client.

```typescript
import { base } from 'waterbed';
import { projects } from './generated-schema'; // Your generated schema

const db = base({
  apiKey: process.env.AIRTABLE_API_KEY!,
  baseId: process.env.AIRTABLE_BASE_ID!,
});
```

### 3. Query Your Data

You can now build and execute queries. The API is designed to be intuitive and chainable. All queries are "thenable", so you can `await` them directly.

**Fetch all records and fields from a table:**

```typescript
const allProjects = await db.select().from(projects);
/*
allProjects is typed as:
{
  id: string;
  projectName?: string;
  budget?: number;
  isComplete?: boolean;
}[]
*/
```

**Select specific fields:**

Return only the data you need. The result type will automatically adjust.

```typescript
const projectNames = await db
  .select({
    name: projects.projectName,
  })
  .from(projects);

/*
projectNames is typed as:
{
  id: string;
  name?: string;
}[]
*/
```

**Filter records with the formula builder:**

Use the built-in formula functions (`eq`, `and`, `or`, `gt`, etc.) to create filters.

```typescript
import { and, gt, eq } from 'waterbed';

const activeHighBudgetProjects = await db
  .select({
    name: projects.projectName,
    cost: projects.budget
  })
  .from(projects)
  .filter(
    and(
      eq(projects.isComplete, false),
      gt(projects.budget, 50000)
    )
  );
```

**Sort results:**

Order your data using `asc` and `desc`.

```typescript
import { desc } from 'waterbed';

const projectsByBudget = await db
  .select()
  .from(projects)
  .orderBy(desc(projects.budget));
```

**Use a specific view:**

Filter and sort data using a pre-configured Airtable view.

```typescript
const activeProjects = await db
  .select()
  .from(projects)
  .view(projects.views.activeProjects);
```

## API Reference

### `base(config)`

Initializes the database client.
-   `config`: An object with `apiKey` and `baseId`.

### Query Builder

-   `db.select()`: Start a query to fetch all defined fields from a table.
-   `db.select({ key: table.field, ... })`: Start a query to fetch specific fields, aliasing them as `key`.
-   `.from(table)`: Specify the table to query.
-   `.filter(formula)`: Apply a filter condition using the [Formula Builder](#formula-builder).
-   `.orderBy(sortCondition, ...)`: Sort the results. Use `asc(field)` or `desc(field)`.
-   `.view(viewName)`: Use a pre-defined Airtable view for filtering and sorting.

### Formula Builder

Import functions like `eq`, `and`, `or`, etc., from `waterbed` to build your filter logic.

-   **Comparison**: `eq`, `neq`, `gt`, `gte`, `lt`, `lte`
-   **Logical**: `and`, `or`, `not`
-   **Text**: `lower`, `upper`, `concatenate`, `trim`, `len`
-   **Numeric**: `sum`, `average`, `min`, `max`
-   **Conditional**: `ifs`, `blank`, `error`

**Example:**

```typescript
import { or, eq, lower } from 'waterbed';

// ...
.filter(
  or(
    eq(projects.isComplete, true),
    eq(lower(projects.projectName), 'side project')
  )
)
```

## Local Development

To contribute or run this project locally:

1.  Clone the repository.
2.  Install dependencies:
    ```bash
    bun install
    ```
3.  Run the tests:
    ```bash
    bun test
    ```